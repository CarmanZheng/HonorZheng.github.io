---
title: 机器学习基础-Pandas
layout: post
tags: 机器学习
categories: ''
---

## 1.数据结构

​		pandas 中具有两种基本的数据存储结构，存储**一维 values 的 Series **和存储**二维 values 的 DataFrame** ，在 这两种结构上定义了很多的属性和方法。

### 	1.Series数据结构

​		Series 一般由四个部分组成，分别是序列的值 data 、索引 index 、存储类型 dtype 、序列的名字 name 。其 中，索引也可以指定它的名字，默认为空。

​		object 代表了一种混合类型，正如上面的例子中存储了整数、字符串以及 Python 的字典数据结 构。此外，目前 pandas 把纯字符串序列也默认认为是一种 object 类型的序列，但它也可以用 string 类型存储。

```python
# Series 构造，数据 + index ，当然后面可以指定dtype，name
In [3]: s = pd.Series(np.random.randn(5), index=["a", "b", "c", "d", "e"]，dtype='float64',name='myame')

In [4]: s
Out[4]: 
a    0.480768
b   -1.296140
c   -1.485106
d    0.834005
e    1.015507
Name: myame, dtype: float64
# 获取属性
In [5]: s.name
Out[5]: 'myame'
```

```python
# 字典转换为Series
In [7]: d = {"b": 1, "a": 0, "c": 2}

In [8]: pd.Series(d)
Out[8]: 
b    1
a    0
c    2
dtype: int64
```

### 	2.Dataframe数据结构

​	DataFrame 在 Series 的基础上增加了列索引，一个数据框可以由二维的 data 与行列索引来构造。

```python
# 两个Series构造一个Dataframe 
    d = {
   ....:     "one": pd.Series([1.0, 2.0, 3.0], index=["a", "b", "c"]),
   ....:     "two": pd.Series([1.0, 2.0, 3.0, 4.0], index=["a", "b", "c", "d"]),
   ....: }

In [38]: df = pd.DataFrame(d)

In [39]: df
Out[39]: 
   one  two
a  1.0  1.0
b  2.0  2.0
c  3.0  3.0
d  NaN  4.0

# 此时 index就是行标签，columns就是列标签
In [41]: pd.DataFrame(d, index=["d", "b", "a"], columns=["two", "three"])
Out[41]: 
   two three
d  4.0   NaN
b  2.0   NaN
a  1.0   NaN
```

```python
# 字典构建Dataframe
In [44]: d = {"one": [1.0, 2.0, 3.0, 4.0], "two": [4.0, 3.0, 2.0, 1.0]}

# 不指定index，默认从0开始
In [45]: pd.DataFrame(d)
Out[45]: 
   one  two
0  1.0  4.0
1  2.0  3.0
2  3.0  2.0
3  4.0  1.0

In [46]: pd.DataFrame(d, index=["a", "b", "c", "d"])
Out[46]: 
   one  two
a  1.0  4.0
b  2.0  3.0
c  3.0  2.0
d  4.0  1.0
```

```python
# 结构化数组，可存储不同类型的数据
In [47]: data = np.zeros((2,), dtype=[("A", "i4"), ("B", "f4"), ("C", "a10")])

In [48]: data[:] = [(1, 2.0, "Hello"), (2, 3.0, "World")]

In [49]: pd.DataFrame(data)
Out[49]: 
   A    B         C
0  1  2.0  b'Hello'
1  2  3.0  b'World'
```

## 2.数据导入

​	pandas 可以读取的文件格式有很多，这里主要介绍读取常用的三种格式数据 csv, excel, txt 文件。

### 	1.读取csv文件

```python
df_csv = pd.read_csv('data/my_csv.csv')
In [5]: df_csv
Out[5]:
col1 col2 col3 col4 col5
0 2 a 1.4 apple 2020/1/1
1 3 b 3.4 banana 2020/1/2
2 6 c 2.5 orange 2020/1/5
3 5 d 3.2 lemon 2020/1/7
```

### 2.读取txt文件

​	读取txt文件中，可能存在分割符的情况，需要使用分割参数`sep`

```python
# 列与列之间的分隔符为 |
In [6]: df_txt = pd.read_table('data/my_table.txt',sep='|')
In [7]: df_txt
Out[7]:
    col1 col2 col3 col4
0 2 a 1.4 apple 2020/1/1
1 3 b 3.4 banana 2020/1/2
2 6 c 2.5 orange 2020/1/5
3 5 d 3.2 lemon 2020/1/7
```

### 3.读取excel文件

```python
In [8]: df_excel = pd.read_excel('data/my_excel.xlsx')
In [9]: df_excel
Out[9]:
col1 col2 col3 col4 col5
0 2 a 1.4 apple 2020/1/1
1 3 b 3.4 banana 2020/1/2
2 6 c 2.5 orange 2020/1/5
3 5 d 3.2 lemon 2020/1/7
```

| 参数        | 说明                       |
| ----------- | -------------------------- |
| index_col   | 将某一列或几列作为索引     |
| header=None | 表示第一行不作为列名       |
| usecols     | 读取列的集合，默认是所有列 |
| nrows       | 读取的行数                 |
| parse_dates | 将某一列转换为时间         |

```python
# 对几个重要参数的说明
In [10]: pd.read_table('data/my_table.txt', header=None)
Out[10]:
0 1 2 3
0 col1 col2 col3 col4
1 2 a 1.4 apple 2020/1/1
2 3 b 3.4 banana 2020/1/2
3 6 c 2.5 orange 2020/1/5
4 5 d 3.2 lemon 2020/1/7

In [11]: pd.read_csv('data/my_csv.csv', index_col=['col1', 'col2'])
Out[11]:
col3 col4 col5
col1 col2
2 a 1.4 apple 2020/1/1
3 b 3.4 banana 2020/1/2
6 c 2.5 orange 2020/1/5
5 d 3.2 lemon 2020/1/7

In [12]: pd.read_table('data/my_table.txt', usecols=['col1', 'col2'])
Out[12]:
col1 col2
0 2 a
1 3 b
2 6 c
3 5 d

In [13]: pd.read_csv('data/my_csv.csv', parse_dates=['col5'])
Out[13]:
col1 col2 col3 col4 col5
0 2 a 1.4 apple 2020-01-01
1 3 b 3.4 banana 2020-01-02
2 6 c 2.5 orange 2020-01-05
3 5 d 3.2 lemon 2020-01-07

In [14]: pd.read_excel('data/my_excel.xlsx', nrows=2)
Out[14]:
col1 col2 col3 col4 col5
0 2 a 1.4 apple 2020/1/1
1 3 b 3.4 banana 2020/1/2
```

## 3.数据导出

​	将pandas数据写入文件，这里介绍写入csv，excel和txt文件。

txt和csv均可使用`to_csv`方法。

```python
In [17]: df_csv.to_csv('data/my_csv_saved.csv', index=False)
In [18]: df_excel.to_excel('data/my_excel_saved.xlsx', index=False)
In [19]: df_txt.to_csv('data/my_txt_saved.txt', sep='\t', index=False)
```

另，pandas提供转换成`markdown`和`latex`的语言，用 to_markdown 和 to_latex 函数。

```python
In [20]: print(df_csv.to_markdown())
| | col1 | col2 | col3 | col4 | col5 |
|---:|-------:|:-------|-------:|:-------|:---------|
| 0 | 2 | a | 1.4 | apple | 2020/1/1 |
| 1 | 3 | b | 3.4 | banana | 2020/1/2 |
| 2 | 6 | c | 2.5 | orange | 2020/1/5 |
| 3 | 5 | d | 3.2 | lemon | 2020/1/7 |
In [21]: print(df_csv.to_latex())
\begin{tabular}{lrlrll}
\toprule
{} & col1 & col2 & col3 & col4 & col5 \\
\midrule
0 & 2 & a & 1.4 & apple & 2020/1/1 \\
1 & 3 & b & 3.4 & banana & 2020/1/2 \\
2 & 6 & c & 2.5 & orange & 2020/1/5 \\
3 & 5 & d & 3.2 & lemon & 2020/1/7 \\
\bottomrule
\end{tabular}
```

## 4.数据操作

### 	1.索引

#### 	1.1 Series列索引

​	通过 [列名] 可以从 DataFrame 中取出相应的列，返回值 为 Series ，例如从表中取出姓名一列

```python
# 单列 ['列名']选择列
In [3]: df = pd.read_csv('data/learn_pandas.csv',
...: usecols = ['School', 'Grade', 'Name', 'Gender',
...: 'Weight', 'Transfer'])
...:
In [4]: df['Name'].head()
Out[4]:
0 Gaopeng Yang
1 Changqiang You
2 Mei Sun
3 Xiaojuan Sun
4 Gaojuan You
Name: Name, dtype: object
        
# 单列 句点运算符
In [6]: df.Name.head()
Out[6]:
0 Gaopeng Yang
1 Changqiang You
2 Mei Sun
3 Xiaojuan Sun
4 Gaojuan You
Name: Name, dtype: object

        
# 多列
In [5]: df[['Gender', 'Name']].head()
Out[5]:
Gender Name
0 Female Gaopeng Yang
1 Male Changqiang You
2 Male Mei Sun
3 Female Xiaojuan Sun
4 Male Gaojuan You
```

#### 1.2 Series行索引

```python
# 【a】以字符串为索引的 Series;
# df.['索引名']取用；若 Series 只有单个值对应，则返回这个标量值，如果有多个值对应，则返回一个 Series：

s = pd.Series([1, 2, 3, 4, 5, 6],
...: index=['a', 'b', 'a', 'a', 'a', 'c'])
...:
In [8]: s['a']
Out[8]:
a 1
a 3
a 4
a 5
dtype: int64
In [9]: s['b']
Out[9]: 2

# 多行提取    
In [10]: s[['c', 'b']]
Out[10]:
c 6
b 2
dtype: int64    
# 字符串切片，包含两端元素
In [11]: s['c': 'b': -2]
Out[11]:
c 6
a 4
b 2
dtype: int64

# 【b】以整数为索引的 Series
# 和字符串一样，如果使用 [int] 或 [int_list] ，则可以取出对应索引 元素的值
# 整数切片，不包含两端元素
In [14]s = pd.Series(['a', 'b', 'c', 'd', 'e', 'f'],
....: index=[1, 3, 1, 2, 5, 4])
    
In [15]: s[1:-1:2]
Out[15]:
3 b
2 d
dtype: object
```

#### 1.3 Dataframe loc索引器

`loc`是元素索引器，loc 索引器的一般形式是 loc[*, *] ，其中第一个 * 代表行的选择，第二个 * 代表列的选择。

输入的元素是行名称、列名称； 行列的布尔列表

```python
In [16]: df_demo = df.set_index('Name')
In [17]: df_demo.head()
Out[17]:
    	School Grade Gender Weight Transfer
    Name
    Gaopeng Yang Shanghai Jiao Tong University Freshman Female 46.0 N
    Changqiang You Peking University Freshman Male 70.0 N
    Mei Sun Shanghai Jiao Tong University Senior Male 89.0 N
    Xiaojuan Sun Fudan University Sophomore Female 41.0 N
    Gaojuan You Fudan University Sophomore Male 74.0 N

# 【a】* 为单个元素
In [18]: df_demo.loc['Qiang Sun'] # 多个人叫此名字
Out[18]: School Grade Gender Weight Transfer
    Name
    Qiang Sun Tsinghua University Junior Female 53.0 N
    Qiang Sun Tsinghua University Sophomore Female 40.0 N
    Qiang Sun Shanghai Jiao Tong University Junior Female NaN N

# 同时选择行和列
In [20]: df_demo.loc['Qiang Sun', 'School'] # 返回 Series
Out[20]:
    Name
    Qiang Sun Tsinghua University
    Qiang Sun Tsinghua University
    Qiang Sun Shanghai Jiao Tong University
    Name: School, dtype: object
        
#【b】* 为元素列表
In [22]: df_demo.loc[['Qiang Sun','Quan Zhao'], ['School','Gender']]
Out[22]:
    School Gender
    Name
    Qiang Sun Tsinghua University Female
    Qiang Sun Tsinghua University Female
    Qiang Sun Shanghai Jiao Tong University Female
    Quan Zhao Shanghai Jiao Tong University Female

# 【c】* 为布尔列表
# 在实际的数据处理中，根据条件来筛选行是极其常见的，此处传入 loc 的布尔列表与 DataFrame 长度相同，
# 且列表为 True 的位置所对应的行会被选中，False 则会被剔除。
# 例如，选出体重超过 70kg 的学生：
In [28]: df_demo.loc[df_demo.Weight>70].head()
Out[28]:
    School Grade Gender Weight Transfer
    Name
    Mei Sun Shanghai Jiao Tong University Senior Male 89.0 N
    Gaojuan You Fudan University Sophomore Male 74.0 N
    Xiaopeng Zhou Shanghai Jiao Tong University Freshman Male 74.0 N
    Xiaofeng Sun Tsinghua University Senior Male 71.0 N
    Qiang Zheng Shanghai Jiao Tong University Senior Male 87.0 N
# 通过 isin 方法返回的布尔列表等价写出
In [29]: df_demo.loc[df_demo.Grade.isin(['Freshman', 'Senior'])].head()
Out[29]:
    School Grade Gender Weight Transfer
    Name
    Gaopeng Yang Shanghai Jiao Tong University Freshman Female 46.0 N
    Changqiang You Peking University Freshman Male 70.0 N
    Mei Sun Shanghai Jiao Tong University Senior Male 89.0 N
    Xiaoli Qian Tsinghua University Freshman Female 51.0 N
    Qiang Chu Shanghai Jiao Tong University Freshman Female 52.0 N

# 【d】* 为函数
# 通过函数构造复杂的筛选条件
In [39]: def condition(x):
....: condition_1_1 = x.School == 'Fudan University'
....: condition_1_2 = x.Grade == 'Senior'
....: condition_1_3 = x.Weight > 70
....: condition_1 = condition_1_1 & condition_1_2 & condition_1_3
....: condition_2_1 = x.School == 'Peking University'
....: condition_2_2 = x.Grade == 'Senior'
....: condition_2_3 = x.Weight > 80
....: condition_2 = condition_2_1 & (~condition_2_2) & condition_2_3
....: result = condition_1 | condition_2
....: return result
....:
In [40]: df_demo.loc[condition]
Out[40]:
School Grade Gender Weight Transfer
Name
Qiang Han Peking University Freshman Male 87.0 N
Chengpeng Zhou Fudan University Senior Male 81.0 N
Changpeng Zhao Peking University Freshman Male 83.0 N
Chengpeng Qian Fudan University Senior Male 73.0 Y
```

#### 1.4 Dataframe iloc索引器

iloc 的使用与 loc 完全类似，只不过是针对位置进行筛选。

在相应的 * 位置处一共也有五类合法对象，分别 是：整数、整数列表、整数切片、布尔列表以及函数，函数的返回值必须是前面的四类合法对象中的一个，其 输入同样也为 DataFrame 本身。

```python
# 输入行号，列号
In [51]: df_demo.iloc[1, 1] # 第二行第二列
Out[51]: 'Freshman'

# 输入行列表，列列表
In [52]: df_demo.iloc[[0, 1], [0, 1]] # 前两行前两列
Out[52]:
    School Grade
    Name
    Gaopeng Yang Shanghai Jiao Tong University Freshman
    Changqiang You Peking University Freshman

# 输入行切片，列切片
In [53]: df_demo.iloc[1: 4, 2:4] # 切片不包含结束端点
Out[53]:
    Gender Weight
    Name
    Changqiang You Male 70.0
    Mei Sun Male 89.0
    Xiaojuan Sun Female 41.0

# 布尔筛选时，需要传入序列的values，否则报错；
# 所以布尔筛选优先使用loc的方式
In [55]: df_demo.iloc[(df_demo.Weight>80).values].head()
Out[55]:
    School Grade Gender Weight Transfer
    Name
    Mei Sun Shanghai Jiao Tong University Senior Male 89.0 N
    Qiang Zheng Shanghai Jiao Tong University Senior Male 87.0 N
    Qiang Han Peking University Freshman Male 87.0 N
    Chengpeng Zhou Fudan University Senior Male 81.0 N
    Feng Han Shanghai Jiao Tong University Sophomore Male 82.0 N
```

#### 1.5 多重索引

此部分在目前的数据分析中用的少，待后期用的多时再行补充

### 2.分组

分组操作在日常生活中使用极其广泛，例如： 

• 依据 性别分组，统计全国人口 寿命的 平均值 

• 依据 季节分组，对每一个季节的 温度进行 组内标准化 

• 依据 班级分组，筛选出组内 数学分数的 平均值超过 80 分的班级

分组一般包含三个必要的元素： 分组依据、数据来源、返回结果

```python
df.groupby(分组依据)[数据来源].使用操作
# 现在返回到学生体测的数据集上，如果想要按照性别统计身高中位数
In [3]: df = pd.read_csv('data/learn_pandas.csv')
In [4]: df.groupby('Gender')['Height'].median()
Out[4]:
    Gender
Female 159.6
Male 173.4
Name: Height, dtype: float64
```

